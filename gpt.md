–ù–∏–∂–µ –¥–∞—é –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ–µ, –Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ç–æ–≥–æ, —á—Ç–æ –∑–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç. –≠—Ç–æ **–ø—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è TDLib** (Telegram Database Library) –Ω–∞ C++.

---

# üß© –û–±—â–∞—è –∏–¥–µ—è

–≠—Ç–æ—Ç —Ñ–∞–π–ª ‚Äî **–ø–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä** –∫–ª–∏–µ–Ω—Ç–∞ Telegram, –Ω–∞–ø–∏—Å–∞–Ω–Ω–æ–≥–æ –Ω–∞ C++ –ø–æ–≤–µ—Ä—Ö TDLib.
–û–Ω:

1. –ó–∞–ø—É—Å–∫–∞–µ—Ç TDLib.
2. –ê–≤—Ç–æ—Ä–∏–∑—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–µ–ª–µ—Ñ–æ–Ω, –∫–æ–¥, –ø–∞—Ä–æ–ª—å, e-mail –∏ —Ç.–ø.).
3. –ü–æ–ª—É—á–∞–µ—Ç –∞–ø–¥–µ–π—Ç—ã: –Ω–æ–≤—ã–µ —á–∞—Ç—ã, –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —é–∑–µ—Ä–æ–≤.
4. –ü–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑ –∫–æ–Ω—Å–æ–ª–∏:

    * —Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤,
    * —É–∑–Ω–∞–≤–∞—Ç—å —Å–µ–±—è (`getMe`),
    * –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è,
    * –≤—ã—Ö–æ–¥–∏—Ç—å,
    * –∏ —Ç.–ø.

–†–∞–±–æ—Ç–∞–µ—Ç –≤ **–æ–¥–Ω–æ–ø–æ—Ç–æ—á–Ω–æ–º —Ä–µ–∂–∏–º–µ**: –æ–±—â–µ–Ω–∏–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤ `std::cin`, –∞ —Å TDLib —á–µ—Ä–µ–∑ `ClientManager`.

---

# üõ† –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

## ‚úî `ClientManager`

–ì–ª–∞–≤–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å TDLib:

* `send` ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
* `receive` ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
* TDLib API –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ

–ü—Ä–∏–º–µ—Ä —Å–æ–∑–¥–∞—ë—Ç:

```cpp
client_manager_ = std::make_unique<td::ClientManager>();
client_id_ = client_manager_->create_client_id();
```

---

## ‚úî –ú–µ—Ö–∞–Ω–∏–∑–º `send_query`

–ö–∞–∂–¥—ã–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π `query_id`:

```cpp
client_manager_->send(client_id_, query_id, std::move(f));
```

–ï—Å–ª–∏ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –µ—Å—Ç—å callback ‚Äî –æ–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `handlers_`.

–ö–æ–≥–¥–∞ TDLib –≤–µ—Ä–Ω—ë—Ç –æ—Ç–≤–µ—Ç ‚Äî –æ–Ω –±—É–¥–µ—Ç –ø–æ–π–º–∞–Ω –≤ `process_response()`.

---

## ‚úî –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–ø–¥–µ–π—Ç–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤

–í—Å–µ –æ—Ç–≤–µ—Ç—ã TDLib –¥–µ–ª—è—Ç—Å—è –Ω–∞:

1. **–û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–∞—à–∏ –∑–∞–ø—Ä–æ—Å—ã** (`request_id != 0`)
2. **–ê–ø–¥–µ–π—Ç—ã** (`request_id == 0`)

### ‚ñ∂ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤

```cpp
auto it = handlers_.find(response.request_id);
if (it != handlers_.end()) {
    it->second(std::move(response.object));
    handlers_.erase(it);
}
```

–¢–æ –µ—Å—Ç—å –µ—Å–ª–∏ –≤—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, `getMe()`, —Ç–æ –ø—Ä–∏—Ö–æ–¥—è—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ø–∞–¥—ë—Ç –≤ –≤–∞—à callback.

---

### ‚ñ∂ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–ø–¥–µ–π—Ç–æ–≤ (update*)

–ê–ø–¥–µ–π—Ç—ã ‚Äî —ç—Ç–æ —Å–æ–±—ã—Ç–∏—è –æ—Ç Telegram:

* updateAuthorizationState
* updateNewChat
* updateNewMessage
* updateUser
* updateChatTitle
  –∏ —Ç.–¥.

–ö–æ–¥ –≤—ã–∑—ã–≤–∞–µ—Ç:

```cpp
process_update(std::move(response.object))
```

–ê –≤–Ω—É—Ç—Ä–∏ ‚Äî –æ–≥—Ä–æ–º–Ω—ã–π `downcast_call`:

```cpp
td_api::downcast_call(
    *update,
    overloaded(
        [](td_api::updateAuthorizationState &...),
        [](td_api::updateNewMessage &...),
        ...
    ));
```

`overloaded` ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —Ç—Ä—é–∫, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å visitor –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ª—è–º–±–¥.

---

# üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

## –ì–ª–∞–≤–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è:

```cpp
td_api::object_ptr<td_api::AuthorizationState> authorization_state_;
```

TDLib –ø—Ä–∏—Å—ã–ª–∞–µ—Ç updateAuthorizationState, –∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –≤—ã–∑—ã–≤–∞–µ—Ç:

```cpp
on_authorization_state_update();
```

–î–∞–ª—å—à–µ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π:

### ‚úî `authorizationStateWaitPhoneNumber`

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –Ω–æ–º–µ—Ä ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è `setAuthenticationPhoneNumber`.

### ‚úî `authorizationStateWaitCode`

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç SMS-–∫–æ–¥ ‚Üí `checkAuthenticationCode`.

### ‚úî `authorizationStateWaitPassword`

–í–≤–æ–¥ –ø–∞—Ä–æ–ª—è ‚Üí `checkAuthenticationPassword`.

### ‚úî `authorizationStateWaitEmailAddress`, WaitEmailCode`

–ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ email.

### ‚úî `authorizationStateWaitTdlibParameters`

TDLib –∂–¥—ë—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (API ID, HASH, –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ë–î):

```cpp
request->api_id_ = 94575;
request->api_hash_ = "a3406de8d171bb422bb6ddf3bbd800e2";
```

### ‚úî `authorizationStateReady`

–ì–æ—Ç–æ–≤–æ ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω.

---

# üí¨ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π

–ö–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:

```cpp
updateNewMessage
```

–ü—Ä–æ–≥—Ä–∞–º–º–∞:

1. –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∞–≤—Ç–æ—Ä–∞ (user/chat)
2. –µ—Å–ª–∏ `messageText`, –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–∫—Å—Ç
3. –ø–µ—á–∞—Ç–∞–µ—Ç:

```
Receive message: [chat_id:...] [from:...] [text...]
```

---

# üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π

–ö–æ–º–∞–Ω–¥–∞:

```
m <chat_id> <text>
```

–ü—Ä–∏–≤–æ–¥–∏—Ç –∫:

```cpp
auto send_message = td_api::make_object<td_api::sendMessage>();
send_message->chat_id_ = chat_id;

auto message_content = td_api::make_object<td_api::inputMessageText>();
message_content->text_->text_ = text;

send_message->input_message_content_ = std::move(message_content);

send_query(std::move(send_message), {});
```

---

# üß∑ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤

–ö–æ–º–∞–Ω–¥–∞:

```
c
```

–í—ã–∑—ã–≤–∞–µ—Ç:

```cpp
getChats(offset = nullptr, limit = 20)
```

–í callback –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø–µ—á–∞—Ç–∞–µ—Ç id –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —á–∞—Ç–æ–≤.

---

# üîÅ –¶–∏–∫–ª —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–≥—Ä–∞–º–º—ã

–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª `loop()`:

* –µ—Å–ª–∏ –Ω–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ‚Üí –ø—Ä–æ—Å—Ç–æ —Å–ª—É—à–∞–µ—Ç TDLib (`receive`)
* –∫–æ–≥–¥–∞ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Üí –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –º–µ–Ω—é:

```
[q] quit
[u] check updates
[c] show chats
[m <chat_id> <text>] send message
[me] show self
[l] logout
```

---

# üßπ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ TDLib

–ï—Å–ª–∏ –ø–æ–ª—É—á–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ `authorizationStateClosed`, –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è `need_restart_ = true`, –∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–µ–±—è:

```cpp
*this = TdExample();
```

---

# üß† –ò—Ç–æ–≥: —á—Ç–æ –¥–µ–ª–∞–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º–∞

–≠—Ç–æ **–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å–æ–ª—å–Ω—ã–π Telegram-–∫–ª–∏–µ–Ω—Ç**, –∫–æ—Ç–æ—Ä—ã–π:

‚úî –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ TDLib
‚úî –ø—Ä–æ—Ö–æ–¥–∏—Ç –≤—Å—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
‚úî –ø–æ–ª—É—á–∞–µ—Ç –∞–ø–¥–µ–π—Ç—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
‚úî –ø–µ—á–∞—Ç–∞–µ—Ç –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
‚úî —Ö—Ä–∞–Ω–∏—Ç –∫—ç—à —é–∑–µ—Ä–æ–≤ –∏ —á–∞—Ç–æ–≤
‚úî –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
‚úî —É–º–µ–µ—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
‚úî –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–µ—Å—è—Ç–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
‚úî –∂–∏–≤—ë—Ç –≤ –æ–¥–Ω–æ–º –ø–æ—Ç–æ–∫–µ

–≠—Ç–æ —ç—Ç–∞–ª–æ–Ω–Ω—ã–π –ø—Ä–∏–º–µ—Ä TDLib, –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ—Ç–æ—Ä–æ–≥–æ —Å—Ç—Ä–æ—è—Ç –Ω–∞—Å—Ç–æ—è—â–∏–µ –∫–ª–∏–µ–Ω—Ç—ã.

---

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –º–æ–≥—É:

* —Ä–∞–∑–æ–±—Ä–∞—Ç—å **–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –±–ª–æ–∫** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–±—Ä–∞–±–æ—Ç–∫—É –∞–ø–¥–µ–π—Ç–æ–≤);
* –æ–±—ä—è—Å–Ω–∏—Ç—å, –∫–∞–∫ **–ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ —ç—Ç–æ –≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã–π —Ä–µ–∂–∏–º**;
* –Ω–∞–ø–∏—Å–∞—Ç—å —É–ø—Ä–æ—â—ë–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –∫–æ–¥–∞ –±–µ–∑ –±–æ–π–ª–µ—Ä–ø–ª–µ–π—Ç–∞;
* –Ω–∞–ø–∏—Å–∞—Ç—å **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π C++20 TDLib-–∫–ª–∏–µ–Ω—Ç**.
